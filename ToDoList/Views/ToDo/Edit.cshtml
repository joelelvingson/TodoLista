@model ToDoList.ViewModel.ToDoFormViewModel
@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="col-sm-offset-4 col-sm-4">
        <h2 id="namnet" class="col-sm-offset-2">@Model.Todo.Name</h2>

        <form name="toDoList" class="col-sm-offset-2">
            <input type="text" name="ListItem" id="namnns" />
            <span id="button" class="btn btn-sm btn-primary">Add</span>
        </form>
        <div class="form-group">
            <input id="hej" type="hidden" ToDoId="@Model.Todo.Id" />
        </div>
        <br />
        <ol class="list-group"></ol>
    </div>
</div>

@section scripts{
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

    <script>

        $(document).ready(function () {
            var bog = $('#hej').attr('ToDoId')
            $.ajax({

                url: "/api/Task?ToDoI=" + bog,
                type: "GET",
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].status == true)
                        {
                            //if (data[i].ToDoId == bog)
                            //{
                            $('ol').append('<li class="' + data[i].Id + ' list-group-item" taskIdTo="' + data[i].Id + '">' + data[i].Name + '<span class="' + data[i].Id + '100 glyphicon glyphicon-remove pull-right"></span></li>');
                            //}

                                $("." + data[i].Id).css("text-decoration", "line-through");
                                $("." + data[i].Id).css("background-color", "grey");
                            
                        }
                        else
                        {
                            $('ol').prepend('<li class="' + data[i].Id + ' list-group-item" taskIdTo="' + data[i].Id + '">' + data[i].Name + '<span class="' + data[i].Id + '100 glyphicon glyphicon-remove pull-right"></span></li>');
                        }
                        $('.' + data[i].Id + '100').on("click", deleteTask);
                        $('.' + data[i].Id).on("click", movePost);

                        
                    }

                }

            })

            $('#button').on("click", create);

            function create() {
                var name = $('#namnns').val();
                var vm =
                {
                    ToDoId: $('#hej').attr('ToDoId'),
                    name: name
                };

                //vm.name = name;
                $.ajax({
                    url: "/api/Task/",
                    method: "post",
                    data: vm,
                    success: function (data) {
                        $('ol').append('<li class="' + data.Id + ' list-group-item" taskIdTo="' + data.Id + '">' + data.Name + '<span class="' + data.Id + '100 glyphicon glyphicon-remove pull-right"></span></li>');
                        $('.' + data.Id + '100').on("click", deleteTask);
                        $('.' + data.Id).on("click", movePost);

                    }
                });


            };

            function movePost() {

                var status;

                var color = $(this).css("background-color");
                if (color == "rgb(128, 128, 128)") {
                    $(this).css("text-decoration", "");
                    $(this).animate({ "background-color": "transparent" }, 'slow');


                    status = false;
                    $(this).prependTo('ol');
                }
                else {

                    $(this).css("text-decoration", "line-through");
                    $(this).animate({ "background-color": "gray" }, 'slow');
                    status = true;
                    $(this).appendTo('ol');
                }
                var vm = {
                    Name: $(this).text(),
                    Id: $(this).attr('TaskIdTo'),
                    status: status,
                    ToDoId: bog
                };


                $.ajax({
                    url: "/api/task?taskDto=",
                    method: "put",
                    data: vm
                })
            };

            $('input').focus(function () {
                $(this).val('');
            });

            function deleteTask() {
                var button = $(this);
                $.ajax({
                    url: "/api/Task?Id=" + $(this).parents('li').attr("taskIdTo"),
                    method: "DELETE",
                    success: function () {

                    }

                });
                $(this).parents('li').remove();
            };

            $('ol').sortable();
            $("#namnet").on("click", editName);

            function editName() {
                var name = $(this).text();
                $(this).html('');
                $('<input></input>')
                  .attr({
                      'type': 'text',
                      'name': 'fname',
                      'id': 'txt_fullname',
                      'size': '30',
                      'value': name
                  })
                  .appendTo('#namnet');
                $('#txt_fullname').focus();
            };

            $(document).on('blur', '#txt_fullname', function () {
                var name = $(this).val();
                if (name == "" || name == " ") {
                    name = "NULL";
                }
                //alert('Make an AJAX call and pass this parameter >> name=' + name);
                $('#namnet').text(name);
                editNameApi();
            });

            $('#namnet').keypress(function (e) {
                if (e.which == 13) {//Enter key pressed
                    {
                        var name = $(this).val();
                        if (name == "" || name == " ") {
                            name = "NULL";
                        }
                        //alert('Make an AJAX call and pass this parameter >> name=' + name);
                        $('#namnet').text(name);
                        editNameApi();
                    }
                }
            });

            function editNameApi() {

                vm = {
                    Name: $("#namnet").text(),
                    Id: $('#hej').attr('ToDoId')
                };
                console.log(vm.Name);
                console.log(vm.Id);
                $.ajax({

                    url: "/api/Todo?toDoDto=",
                    type: "put",
                    data: vm

                })
            };
        }
 );
    </script>

}